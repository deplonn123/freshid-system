<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan - FRESH-ID</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/professional-theme.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="header-content">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="images/logo-freshid.jpg" alt="FRESH-ID Logo" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
                </div>
                <div class="brand-info">
                    <h1>FRESH-ID</h1>
                    <p>Monitoring System</p>
                </div>
            </div>
            
            <div class="page-title-section">
                <h2>Laporan</h2>
            </div>
            
            <div class="header-actions">
                <button class="header-icon-btn" onclick="window.location.href='notifikasi.html'">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
                
                <button class="header-icon-btn" onclick="window.location.href='pengaturan.html'">
                    <i class="fas fa-cog"></i>
                </button>
                
                <div class="user-menu" onclick="logout()">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <span class="user-name">Admin</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchMenu" placeholder="Cari menu...">
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item" data-menu="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                
                <!-- Monitoring dengan Submenu -->
                <div class="nav-item has-submenu" data-menu="monitoring">
                    <a href="javascript:void(0)" onclick="toggleSubmenu(this)">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-desktop"></i>
                            <span>Monitoring</span>
                        </div>
                        <i class="fas fa-chevron-down submenu-arrow"></i>
                    </a>
                    <div class="submenu">
                        <a href="data-sensor.html" class="submenu-item" data-menu="data-sensor">
                            <i class="fas fa-chart-line"></i>
                            <span>Data Sensor</span>
                        </a>
                        <a href="status-kesegaran.html" class="submenu-item" data-menu="status-kesegaran">
                            <i class="fas fa-check-circle"></i>
                            <span>Status Kesegaran</span>
                        </a>
                        <a href="sampel-sapi.html" class="submenu-item" data-menu="sampel-sapi">
                            <i class="fas fa-cow"></i>
                            <span>Sampel Daging Sapi</span>
                        </a>
                        <a href="sampel-ayam.html" class="submenu-item" data-menu="sampel-ayam">
                            <i class="fas fa-drumstick-bite"></i>
                            <span>Sampel Daging Ayam</span>
                        </a>
                        <a href="sampel-ikan.html" class="submenu-item" data-menu="sampel-ikan">
                            <i class="fas fa-fish"></i>
                            <span>Sampel Ikan</span>
                        </a>
                        <a href="sampel-susu.html" class="submenu-item" data-menu="sampel-susu">
                            <i class="fas fa-glass-whiskey"></i>
                            <span>Sampel Susu</span>
                        </a>
                    </div>
                </div>
                
                <a href="laporan.html" class="nav-item" data-menu="laporan">
                    <i class="fas fa-file-alt"></i>
                    <span>Laporan</span>
                </a>
                <a href="notifikasi.html" class="nav-item" data-menu="notifikasi">
                    <i class="fas fa-bell"></i>
                    <span>Notifikasi</span>
                </a>
                <a href="pengaturan.html" class="nav-item" data-menu="pengaturan">
                    <i class="fas fa-cog"></i>
                    <span>Pengaturan</span>
                </a>
                <a href="manajemen-pengguna.html" class="nav-item" data-menu="manajemen-pengguna">
                    <i class="fas fa-users"></i>
                    <span>Manajemen Pengguna</span>
                </a>
                <a href="dokumentasi.html" class="nav-item" data-menu="dokumentasi">
                    <i class="fas fa-book"></i>
                    <span>Dokumentasi</span>
                </a>
                <a href="referensi.html" class="nav-item" data-menu="referensi">
                    <i class="fas fa-link"></i>
                    <span>Referensi</span>
                </a>
                <a href="tentang.html" class="nav-item" data-menu="tentang">
                    <i class="fas fa-info-circle"></i>
                    <span>Tentang</span>
                </a>
                <a href="#" class="nav-item" onclick="logout(); return false;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Keluar</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1>Laporan</h1>
                    <p>Generate dan lihat laporan monitoring</p>
                </div>

                <!-- Page Content -->

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-filter"></i> Parameter Laporan</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Jenis Laporan</label>
                                <select class="form-control" id="reportType">
                                    <option value="harian">Laporan Harian</option>
                                    <option value="mingguan">Laporan Mingguan</option>
                                    <option value="bulanan">Laporan Bulanan</option>
                                    <option value="custom">Laporan Custom</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Produk</label>
                                <select class="form-control" id="reportProduct">
                                    <option value="semua">Semua Produk</option>
                                    <option value="sapi">Daging Sapi</option>
                                    <option value="ayam">Daging Ayam</option>
                                    <option value="ikan">Ikan</option>
                                    <option value="susu">Susu</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tanggal Mulai</label>
                                <input type="date" class="form-control" id="startDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tanggal Akhir</label>
                                <input type="date" class="form-control" id="endDate">
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="generateReport()">
                                <i class="fas fa-file-alt"></i> Generate Laporan
                            </button>
                            <button class="btn btn-success" onclick="exportPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="btn" style="background: #10b981; color: white;" onclick="exportExcel()">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-history"></i> Riwayat Laporan</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Jenis</th>
                                        <th>Produk</th>
                                        <th>Periode</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="reportHistoryTable">
                                    <tr>
                                        <td>11 Des 2025</td>
                                        <td>Laporan Harian</td>
                                        <td>Semua Produk</td>
                                        <td>10 Des 2025</td>
                                        <td><span class="badge badge-success">Selesai</span></td>
                                        <td><button class="btn btn-sm btn-primary" onclick="downloadReport(1)"><i class="fas fa-download"></i> Download</button></td>
                                    </tr>
                                    <tr>
                                        <td>10 Des 2025</td>
                                        <td>Laporan Mingguan</td>
                                        <td>Daging Sapi</td>
                                        <td>4-10 Des 2025</td>
                                        <td><span class="badge badge-success">Selesai</span></td>
                                        <td><button class="btn btn-sm btn-primary" onclick="downloadReport(2)"><i class="fas fa-download"></i> Download</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Preview Modal -->
                <div id="reportPreviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto;">
                    <div class="card" style="width: 90%; max-width: 1000px; margin: 2rem auto;">
                        <div class="card-header" style="background: var(--primary); color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 class="card-title" style="color: white; margin: 0;">
                                    <i class="fas fa-file-alt"></i> Preview Laporan
                                </h3>
                                <button onclick="closePreviewModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="reportPreviewContent">
                            <!-- Report content will be generated here -->
                        </div>
                    </div>
                </div>

                <script>
                    // Set default dates
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    document.getElementById('startDate').valueAsDate = yesterday;
                    document.getElementById('endDate').valueAsDate = today;
                    
                    let reportHistory = [];
                    let currentReportData = null;
                    
                    // Generate sample sensor data for report
                    function generateReportData() {
                        const reportType = document.getElementById('reportType').value;
                        const product = document.getElementById('reportProduct').value;
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        
                        if (!startDate || !endDate) {
                            showToast('Pilih tanggal mulai dan akhir!', 'error');
                            return null;
                        }
                        
                        const data = [];
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                        
                        const products = product === 'semua' 
                            ? ['Daging Sapi', 'Daging Ayam', 'Ikan', 'Susu']
                            : [product === 'sapi' ? 'Daging Sapi' : product === 'ayam' ? 'Daging Ayam' : product === 'ikan' ? 'Ikan' : 'Susu'];
                        
                        for (let d = 0; d < days; d++) {
                            const date = new Date(start);
                            date.setDate(date.getDate() + d);
                            
                            products.forEach(prod => {
                                for (let box = 1; box <= 3; box++) {
                                    const nh3 = (10 + Math.random() * 25).toFixed(2);
                                    const h2s = (5 + Math.random() * 18).toFixed(2);
                                    const ch4 = (20 + Math.random() * 60).toFixed(2);
                                    const temp = (24 + Math.random() * 10).toFixed(1);
                                    const humidity = Math.floor(50 + Math.random() * 30);
                                    
                                    const status = parseFloat(nh3) > 30 ? 'Bahaya' : parseFloat(nh3) > 20 ? 'Peringatan' : 'Normal';
                                    
                                    data.push({
                                        tanggal: date.toLocaleDateString('id-ID'),
                                        waktu: `${Math.floor(Math.random() * 24).toString().padStart(2, '0')}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`,
                                        produk: prod,
                                        box: `Box ${box}`,
                                        nh3: nh3,
                                        h2s: h2s,
                                        ch4: ch4,
                                        suhu: temp,
                                        kelembaban: humidity,
                                        status: status
                                    });
                                }
                            });
                        }
                        
                        return {
                            type: reportType,
                            product: product,
                            startDate: startDate,
                            endDate: endDate,
                            data: data
                        };
                    }
                    
                    function generateReport() {
                        showToast('Membuat laporan...', 'info');
                        
                        currentReportData = generateReportData();
                        if (!currentReportData) return;
                        
                        setTimeout(() => {
                            showPreviewModal();
                            addToHistory();
                            showToast('Laporan berhasil dibuat!', 'success');
                        }, 1000);
                    }
                    
                    function showPreviewModal() {
                        const modal = document.getElementById('reportPreviewModal');
                        const content = document.getElementById('reportPreviewContent');
                        
                        const productName = currentReportData.product === 'semua' ? 'Semua Produk' :
                                          currentReportData.product === 'sapi' ? 'Daging Sapi' :
                                          currentReportData.product === 'ayam' ? 'Daging Ayam' :
                                          currentReportData.product === 'ikan' ? 'Ikan' : 'Susu';
                        
                        let html = `
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <h2 style="margin-bottom: 0.5rem;">LAPORAN MONITORING FRESH-ID</h2>
                                <p style="font-size: 1.125rem; color: var(--gray-600);">${currentReportData.type.charAt(0).toUpperCase() + currentReportData.type.slice(1)}</p>
                                <p style="color: var(--gray-600);">Periode: ${new Date(currentReportData.startDate).toLocaleDateString('id-ID')} - ${new Date(currentReportData.endDate).toLocaleDateString('id-ID')}</p>
                                <p style="color: var(--gray-600);">Produk: ${productName}</p>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <h3 style="margin-bottom: 1rem;">Ringkasan</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">Total Data</div>
                                        <div style="font-size: 1.5rem; font-weight: 700;">${currentReportData.data.length}</div>
                                    </div>
                                    <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">Status Normal</div>
                                        <div style="font-size: 1.5rem; font-weight: 700;">${currentReportData.data.filter(d => d.status === 'Normal').length}</div>
                                    </div>
                                    <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">Status Peringatan</div>
                                        <div style="font-size: 1.5rem; font-weight: 700;">${currentReportData.data.filter(d => d.status === 'Peringatan').length}</div>
                                    </div>
                                    <div style="padding: 1rem; background: #fee2e2; border-radius: 8px; border-left: 4px solid #ef4444;">
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">Status Bahaya</div>
                                        <div style="font-size: 1.5rem; font-weight: 700;">${currentReportData.data.filter(d => d.status === 'Bahaya').length}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <h3 style="margin-bottom: 1rem;">Data Detail</h3>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Tanggal</th>
                                                <th>Waktu</th>
                                                <th>Produk</th>
                                                <th>Box</th>
                                                <th>NH₃ (ppm)</th>
                                                <th>H₂S (ppm)</th>
                                                <th>CH₄ (ppm)</th>
                                                <th>Suhu (°C)</th>
                                                <th>Kelembaban (%)</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                        
                        currentReportData.data.slice(0, 50).forEach(row => {
                            const statusClass = row.status === 'Normal' ? 'success' : row.status === 'Peringatan' ? 'warning' : 'danger';
                            html += `
                                <tr>
                                    <td>${row.tanggal}</td>
                                    <td>${row.waktu}</td>
                                    <td>${row.produk}</td>
                                    <td>${row.box}</td>
                                    <td>${row.nh3}</td>
                                    <td>${row.h2s}</td>
                                    <td>${row.ch4}</td>
                                    <td>${row.suhu}</td>
                                    <td>${row.kelembaban}</td>
                                    <td><span class="badge badge-${statusClass}">${row.status}</span></td>
                                </tr>`;
                        });
                        
                        if (currentReportData.data.length > 50) {
                            html += `<tr><td colspan="10" style="text-align: center; font-style: italic; color: var(--gray-600);">Menampilkan 50 dari ${currentReportData.data.length} data. Download untuk melihat semua data.</td></tr>`;
                        }
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn btn-success" onclick="exportPDF()">
                                    <i class="fas fa-file-pdf"></i> Download PDF
                                </button>
                                <button class="btn" style="background: #10b981; color: white;" onclick="exportExcel()">
                                    <i class="fas fa-file-excel"></i> Download Excel
                                </button>
                                <button class="btn btn-secondary" onclick="closePreviewModal()">
                                    <i class="fas fa-times"></i> Tutup
                                </button>
                            </div>
                        `;
                        
                        content.innerHTML = html;
                        modal.style.display = 'flex';
                    }
                    
                    function closePreviewModal() {
                        document.getElementById('reportPreviewModal').style.display = 'none';
                    }
                    
                    function addToHistory() {
                        const now = new Date();
                        const productName = currentReportData.product === 'semua' ? 'Semua Produk' :
                                          currentReportData.product === 'sapi' ? 'Daging Sapi' :
                                          currentReportData.product === 'ayam' ? 'Daging Ayam' :
                                          currentReportData.product === 'ikan' ? 'Ikan' : 'Susu';
                        
                        const newReport = {
                            id: reportHistory.length + 3,
                            tanggal: now.toLocaleDateString('id-ID'),
                            jenis: currentReportData.type.charAt(0).toUpperCase() + currentReportData.type.slice(1),
                            produk: productName,
                            periode: `${new Date(currentReportData.startDate).toLocaleDateString('id-ID')} - ${new Date(currentReportData.endDate).toLocaleDateString('id-ID')}`,
                            data: currentReportData.data
                        };
                        
                        reportHistory.unshift(newReport);
                        updateHistoryTable();
                    }
                    
                    function updateHistoryTable() {
                        const tbody = document.getElementById('reportHistoryTable');
                        let html = '';
                        
                        reportHistory.forEach(report => {
                            html += `
                                <tr>
                                    <td>${report.tanggal}</td>
                                    <td>Laporan ${report.jenis}</td>
                                    <td>${report.produk}</td>
                                    <td>${report.periode}</td>
                                    <td><span class="badge badge-success">Selesai</span></td>
                                    <td><button class="btn btn-sm btn-primary" onclick="downloadReport(${report.id})"><i class="fas fa-download"></i> Download</button></td>
                                </tr>`;
                        });
                        
                        // Add existing reports
                        html += `
                            <tr>
                                <td>11 Des 2025</td>
                                <td>Laporan Harian</td>
                                <td>Semua Produk</td>
                                <td>10 Des 2025</td>
                                <td><span class="badge badge-success">Selesai</span></td>
                                <td><button class="btn btn-sm btn-primary" onclick="downloadReport(1)"><i class="fas fa-download"></i> Download</button></td>
                            </tr>
                            <tr>
                                <td>10 Des 2025</td>
                                <td>Laporan Mingguan</td>
                                <td>Daging Sapi</td>
                                <td>4-10 Des 2025</td>
                                <td><span class="badge badge-success">Selesai</span></td>
                                <td><button class="btn btn-sm btn-primary" onclick="downloadReport(2)"><i class="fas fa-download"></i> Download</button></td>
                            </tr>`;
                        
                        tbody.innerHTML = html;
                    }
                    
                    function exportPDF() {
                        if (!currentReportData) {
                            showToast('Generate laporan terlebih dahulu!', 'error');
                            return;
                        }
                        
                        showToast('Membuat PDF...', 'info');
                        
                        setTimeout(() => {
                            try {
                                const { jsPDF } = window.jspdf;
                                const doc = new jsPDF('l', 'mm', 'a4'); // landscape, mm, A4
                                
                                const productName = currentReportData.product === 'semua' ? 'Semua Produk' :
                                                  currentReportData.product === 'sapi' ? 'Daging Sapi' :
                                                  currentReportData.product === 'ayam' ? 'Daging Ayam' :
                                                  currentReportData.product === 'ikan' ? 'Ikan' : 'Susu';
                                
                                const productNameFile = currentReportData.product === 'semua' ? 'Semua_Produk' :
                                                      currentReportData.product === 'sapi' ? 'Daging_Sapi' :
                                                      currentReportData.product === 'ayam' ? 'Daging_Ayam' :
                                                      currentReportData.product === 'ikan' ? 'Ikan' : 'Susu';
                                
                                // Title
                                doc.setFontSize(18);
                                doc.setFont(undefined, 'bold');
                                doc.text('LAPORAN MONITORING FRESH-ID', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                                
                                doc.setFontSize(12);
                                doc.setFont(undefined, 'normal');
                                doc.text(`Laporan ${currentReportData.type.charAt(0).toUpperCase() + currentReportData.type.slice(1)}`, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                                doc.text(`Periode: ${new Date(currentReportData.startDate).toLocaleDateString('id-ID')} - ${new Date(currentReportData.endDate).toLocaleDateString('id-ID')}`, doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
                                doc.text(`Produk: ${productName}`, doc.internal.pageSize.getWidth() / 2, 34, { align: 'center' });
                                
                                // Summary
                                doc.setFontSize(11);
                                doc.setFont(undefined, 'bold');
                                doc.text('RINGKASAN:', 14, 45);
                                
                                doc.setFont(undefined, 'normal');
                                const normalCount = currentReportData.data.filter(d => d.status === 'Normal').length;
                                const warningCount = currentReportData.data.filter(d => d.status === 'Peringatan').length;
                                const dangerCount = currentReportData.data.filter(d => d.status === 'Bahaya').length;
                                
                                doc.text(`Total Data: ${currentReportData.data.length}`, 14, 52);
                                doc.text(`Status Normal: ${normalCount}`, 14, 58);
                                doc.text(`Status Peringatan: ${warningCount}`, 14, 64);
                                doc.text(`Status Bahaya: ${dangerCount}`, 14, 70);
                                
                                // Table
                                const tableData = currentReportData.data.map(row => [
                                    row.tanggal,
                                    row.waktu,
                                    row.produk,
                                    row.box,
                                    row.nh3,
                                    row.h2s,
                                    row.ch4,
                                    row.suhu,
                                    row.kelembaban,
                                    row.status
                                ]);
                                
                                doc.autoTable({
                                    startY: 78,
                                    head: [['Tanggal', 'Waktu', 'Produk', 'Box', 'NH3', 'H2S', 'CH4', 'Suhu', 'Kelembaban', 'Status']],
                                    body: tableData,
                                    styles: { fontSize: 8 },
                                    headStyles: { fillColor: [79, 70, 229], textColor: 255, fontStyle: 'bold' },
                                    alternateRowStyles: { fillColor: [245, 247, 250] },
                                    margin: { left: 14, right: 14 }
                                });
                                
                                // Footer
                                const pageCount = doc.internal.getNumberOfPages();
                                for (let i = 1; i <= pageCount; i++) {
                                    doc.setPage(i);
                                    doc.setFontSize(8);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(`Halaman ${i} dari ${pageCount}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                                    doc.text(`Dicetak: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`, doc.internal.pageSize.getWidth() - 14, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                                }
                                
                                const filename = `Laporan_${currentReportData.type}_${productNameFile}_${currentReportData.startDate}_to_${currentReportData.endDate}.pdf`;
                                doc.save(filename);
                                
                                showToast('PDF berhasil diunduh!', 'success');
                            } catch (error) {
                                console.error('Error generating PDF:', error);
                                showToast('Error membuat PDF. Silakan coba lagi.', 'error');
                            }
                        }, 1000);
                    }
                    
                    function exportExcel() {
                        if (!currentReportData) {
                            showToast('Generate laporan terlebih dahulu!', 'error');
                            return;
                        }
                        
                        showToast('Membuat Excel...', 'info');
                        
                        setTimeout(() => {
                            const productName = currentReportData.product === 'semua' ? 'Semua_Produk' :
                                              currentReportData.product === 'sapi' ? 'Daging_Sapi' :
                                              currentReportData.product === 'ayam' ? 'Daging_Ayam' :
                                              currentReportData.product === 'ikan' ? 'Ikan' : 'Susu';
                            
                            const filename = `Laporan_${currentReportData.type}_${productName}_${currentReportData.startDate}_to_${currentReportData.endDate}.csv`;
                            
                            let csv = 'Tanggal,Waktu,Produk,Box,NH3 (ppm),H2S (ppm),CH4 (ppm),Suhu (°C),Kelembaban (%),Status\\n';
                            
                            currentReportData.data.forEach(row => {
                                csv += `${row.tanggal},${row.waktu},${row.produk},${row.box},${row.nh3},${row.h2s},${row.ch4},${row.suhu},${row.kelembaban},${row.status}\\n`;
                            });
                            
                            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            a.click();
                            URL.revokeObjectURL(url);
                            
                            showToast('Excel berhasil diunduh!', 'success');
                        }, 1000);
                    }
                    
                    function downloadReport(reportId) {
                        const report = reportHistory.find(r => r.id === reportId);
                        
                        if (!report) {
                            showToast('Mengunduh laporan demo...', 'info');
                            setTimeout(() => {
                                showToast('Download simulasi berhasil!', 'success');
                            }, 1000);
                            return;
                        }
                        
                        currentReportData = {
                            type: report.jenis.toLowerCase(),
                            product: report.produk,
                            startDate: report.periode.split(' - ')[0],
                            endDate: report.periode.split(' - ')[1],
                            data: report.data
                        };
                        
                        exportExcel();
                    }
                    
                    function generateTextReport() {
                        const productName = currentReportData.product === 'semua' ? 'Semua Produk' :
                                          currentReportData.product === 'sapi' ? 'Daging Sapi' :
                                          currentReportData.product === 'ayam' ? 'Daging Ayam' :
                                          currentReportData.product === 'ikan' ? 'Ikan' : 'Susu';
                        
                        let text = `
LAPORAN MONITORING FRESH-ID
${currentReportData.type.toUpperCase()}

Periode: ${new Date(currentReportData.startDate).toLocaleDateString('id-ID')} - ${new Date(currentReportData.endDate).toLocaleDateString('id-ID')}
Produk: ${productName}
Total Data: ${currentReportData.data.length}

RINGKASAN:
- Status Normal: ${currentReportData.data.filter(d => d.status === 'Normal').length}
- Status Peringatan: ${currentReportData.data.filter(d => d.status === 'Peringatan').length}
- Status Bahaya: ${currentReportData.data.filter(d => d.status === 'Bahaya').length}

DATA DETAIL:
================================================================================================================
Tanggal\\t\\tWaktu\\tProduk\\t\\tBox\\tNH3\\tH2S\\tCH4\\tSuhu\\tKelembaban\\tStatus
================================================================================================================
`;
                        
                        currentReportData.data.forEach(row => {
                            text += `${row.tanggal}\\t${row.waktu}\\t${row.produk}\\t${row.box}\\t${row.nh3}\\t${row.h2s}\\t${row.ch4}\\t${row.suhu}\\t${row.kelembaban}\\t${row.status}\\n`;
                        });
                        
                        return text;
                    }
                </script>
        
            </div>
        </main>
    </div>

    <!-- Common Scripts -->
    <script src="js/professional-common.js"></script>
    
    <!-- Page Specific Scripts -->
    <script>
        setActiveMenu('laporan');
    </script>
</body>
</html>